version: 2
jobs:
  build:
    working_directory: ~/que
    docker:
      - image: chanks/que-circleci:0.0.2
    environment:
      - RUBY_VERSIONS: "2.2 2.3 2.4"
      - PG_VERSIONS: "9.4 9.5 9.6"
      - PG_PORTS: "5432 5433 5434"
      - GEMFILE_VERSIONS: "current old older oldest"
    steps:
      - checkout

      # Concatenate all our Gemfiles together, so we can update our Bundler
      # cache key whenever any of them change.
      - run: md5sum spec/gemfiles/Gemfile.* > bundler_checksum

      - restore_cache:
          key: bundler-cache-{{checksum "bundler_checksum"}}

      - run:
          command: |
            for ruby_version in $RUBY_VERSIONS
            do
              for gemfile_version in $GEMFILE_VERSIONS
              do
                rvm $ruby_version do bundle install --gemfile spec/gemfiles/Gemfile.$gemfile_version --path vendor
              done
            done

      - save_cache:
          key: bundler-cache-{{checksum "bundler_checksum"}}
          paths:
            # Cache Gemfile.locks, and vendored gems are also under this directory.
            - spec/gemfiles

      - run:
          command: |
            for version in $PG_VERSIONS
            do
              echo "host all all 127.0.0.1/32 trust" > /etc/postgresql/$version/main/pg_hba.conf
              echo "local all all trust" >> /etc/postgresql/$version/main/pg_hba.conf
            done

      # From: https://github.com/nimiq/docker-postgresql93/issues/2
      - run: mkdir /etc/ssl/private-copy; mv /etc/ssl/private/* /etc/ssl/private-copy/; rm -r /etc/ssl/private; mv /etc/ssl/private-copy /etc/ssl/private; chmod -R 0700 /etc/ssl/private; chown -R postgres /etc/ssl/private
      - run: service postgresql start
      - run: for port in $PG_PORTS; do createdb que-test -U postgres -p $port; done

      - run:
          command: |
            for port in $PG_PORTS
            do
              for ruby_version in $RUBY_VERSIONS
              do
                for gemfile_version in $GEMFILE_VERSIONS
                do
                  DATABASE_URL="postgres://postgres:postgres@localhost:$port/que-test" BUNDLE_GEMFILE="spec/gemfiles/Gemfile.$gemfile_version" TEST_OPTS="--verbose --profile" rvm $ruby_version do bundle exec rake
                done
              done
            done
